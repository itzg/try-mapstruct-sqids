Explores the use of [MapStruct](https://mapstruct.org/) to swap out auto-incremented entity IDs with obfuscated string IDs encoded/decoded by [Sqids](https://sqids.org/) for external/web access.

## Try it out

Thanks to [Spring Boot's compose support](https://docs.spring.io/spring-boot/reference/features/dev-services.html#features.dev-services.docker-compose), everything is included to get up and running. Start the application like normal in your IDE or use `./gradlew bootRun`.

Create a task with

```http request
POST http://localhost:8080/tasks
Content-Type: application/json

{
  "name": "test2",
  "dueDate": "2024-12-24T03:24:35+00:00"
}
```

...list tasks

```http request
GET http://localhost:8080/tasks
```

...and confirm the decoding of a sqid with item retrieval, such as

```http request
GET http://localhost:8080/tasks/UkLWa
```

## Highlights

[Entity record](https://docs.spring.io/spring-data/relational/reference/jdbc/mapping.html) declares `@Id` field as a `Long`:
```java
@Table("task")
public record TaskEntity(
    @Id
    Long id,
    String name,
    Instant dueDate,
    boolean completed
) {
}
```

...and Liquibase [table creation](https://docs.liquibase.com/change-types/create-table.html) as an auto-incrementing, `BIGINT`:
```yaml
        - createTable:
            tableName: task
            columns:
              - column:
                  name: id
                  autoIncrement: true
                  type: bigint
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: text
              - column:
                  name: due_date
                  type: timestamptz
              - column:
                  name: completed
                  type: boolean
```

Liquibase generates the following DDL to create the table:

```postgresql
create table task
(
    id        bigint generated by default as identity
        primary key,
    name      text,
    due_date  timestamp with time zone,
    completed boolean
);
```

A `Sqids` bean [using a typical declaration](https://sqids.org/java) is declared:

```java
@Configuration
public class SqidsConfig {
    @Bean
    public Sqids sqids() {
        return Sqids.builder()
            .minLength(4)
            .build();
    }
}
```

...which is used by a Sqid mapper service. Also note the two [mapstruct qualifier](https://mapstruct.org/documentation/stable/reference/html/#selection-based-on-qualifiers) annotations declared and applied. 

```java
@Service
public class SqidMapper {

    private final Sqids sqids;

    public SqidMapper(Sqids sqids) {
        this.sqids = sqids;
    }

    @ToSqid
    public String toSqid(Long id) {
        return sqids.encode(List.of(id));
    }

    @FromSqid
    public Long fromSqid(String sqid) {
        return sqids.decode(sqid).getFirst();
    }

    @Qualifier
    @Target({ ElementType.TYPE, ElementType.METHOD })
    @Retention(RetentionPolicy.CLASS)
    public @interface ToSqid {
    }

    @Qualifier
    @Target({ ElementType.TYPE, ElementType.METHOD })
    @Retention(RetentionPolicy.CLASS)
    public @interface FromSqid {
    }
}
```

The DTO exposed by REST controller declares the `id` field as a `String`:
```java
public record TaskDto(
    String id,
    String name,
    Instant dueDate,
    boolean completed
) {
}
```

The `TaskMapper` is a [mapstruct interface](https://mapstruct.org/documentation/stable/reference/html/#defining-mapper) registered [as a Spring component](https://mapstruct.org/documentation/stable/reference/html/#using-dependency-injection) and [uses](https://mapstruct.org/documentation/stable/reference/html/#invoking-other-mappers) the `SqidMapper` service declared above.

Also note the `qualifiedBy = SqidMapper.ToSqid.class` on the `id` property mapping converting towards the DTO.

```java
@Mapper(componentModel = MappingConstants.ComponentModel.SPRING, uses = {SqidMapper.class})
public interface TaskMapper {
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "completed", ignore = true)
    TaskEntity fromCreate(TaskCreate request);

    @Mapping(target = "id", qualifiedBy = SqidMapper.ToSqid.class)
    TaskDto toDto(TaskEntity task);

    List<TaskDto> toDtoList(Iterable<TaskEntity> tasks);
}
```

The REST controller method for retrieval by ID
1. uses the `SqidMapper`'s `fromSqid` to convert the requested string ID into a database `Long` ID
2. uses the `toDto` mapper method to convert the retrieved database entity's ID back to the Sqid string form

```java
    @GetMapping("/{id}")
    public TaskDto getTask(@PathVariable("id") String id) {
        return taskMapper.toDto(
            taskRepository.findById(
                    sqidMapper.fromSqid(id)
                )
                .orElseThrow(NotFoundException::new)
        );
    }
```